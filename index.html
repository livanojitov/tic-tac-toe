<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tic-Tac-Toe</title>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>

  <style>
    .board{
      width: 370px;
      margin: 40px auto 0 auto;
    }

    .board button{
      width: 100px;
      height:100px;
      margin: 10px;
      border: 1px solid black;
      display:inline-block;
    }

    label{
      font-weight: bold;
    }

    .info{
      text-align: center;
    }
  </style>

</head>
<body>

  <div id="app"></div>

  <script type="text/babel">

    class Board extends React.Component {

      nobody = 0
      computer = 1
      user = 2
      gameOver = false
      message = ''
      state = {
          board : [this.nobody, this.nobody, this.nobody, this.nobody, this.nobody, this.nobody, this.nobody, this.nobody, this.nobody]
      }
      
      computerPlay(){
        this.play(this.computer, Math.floor(Math.random() * this.state.board.length))
      } 

      componentWillMount(){
        this.computerPlay();
      }
       
      startOver = () => {
        let newBoard =  this.state.board;
        newBoard.fill(this.nobody);
        this.gameOver = false;
        this.setState(() => {
            return {
              board : newBoard
            }
        });
        this.computerPlay();    
      }

      render(){
        const board = this.state.board.map((square, ind) => {
            return (<Square 
                      key={ind} 
                      color={ square == this.computer ? 'red' : ( square == this.user ? 'green' : '')} 
                      disableSquare = {this.gameOver ? true : (square != this.nobody ? true : false) }
                      handleClick = {this.handleClick}
                      id={ind}
                    />
            ) 
        });

        return(
          <div className="board">
            <label>The Tic-Tac-Toe game written in React.js</label><br/><br/>
            <a href="https://github.com/livanojitov/tic-tac-toe/blob/master/index.html">Source code</a><br/><br/>
            <label>To start playing click on any square.</label><br/><br/>

            {board}
            <br/>
            <br/>
            <div className="info">  
              {this.gameOver && <label>{this.message}</label>}
              <br/>
              <br/>
              {this.gameOver && <input type="button" value="Start Over" onClick={this.startOver} />}
            </div>            
          </div>
        )
      }

      handleClick = (e) => {

        this.play(this.user,e.target.id);
 
        if (this.hasUserWon()){
          this.gameOver = true;
          this.message = "Game over : You won!";
          return;
        }

        if (this.isBoardFull()){
          this.message = "Game over : It's a Tie.";
          this.gameOver = true;
        }else{
           let winnerSquare = this.isAboutToWin(this.computer);
           if (winnerSquare != -1){
              this.play(this.computer, winnerSquare);
              this.gameOver = true;
              this.message = "Game over : You lost!";
              return;
           }

           winnerSquare = this.isAboutToWin(this.user);

           if (winnerSquare != -1){
              this.play(this.computer, winnerSquare);
           }else{
              for (let i=0; i< this.state.board.length; i++){
                if (this.state.board[i] == this.nobody){
                  this.play(this.computer, i);
                  break;
                }
              }
          }

          if (this.isBoardFull()){
            this.message = "Game over : It's a Tie.";    
            this.gameOver = true;      
          }
        }  
      }

      play(player, square){
        let newBoard = this.state.board;
        newBoard[square] = player;
        this.setState(() => {
          return {
             board : newBoard
          }
        });
      }
      
      check(player, square1, square2, square3){
        const board = this.state.board;
        if (board[square1] == player && board[square2] == player && board[square3] == this.nobody){
          return square3;
        } 
        if (board[square1] == player && board[square2] == this.nobody && board[square3] == player){
          return square2;
        }
        if (board[square1] == this.nobody && board[square2] == player && board[square3] == player){
          return square1;
        } 
        return -1;       
      }

      isAboutToWin(player){
        // first row;
        let square;
        square = this.check(player, 0, 1, 2);
        if (square != -1){
          return square;
        }
        // second row
        square = this.check(player, 3, 4, 5);
        if (square != -1){
          return square;
        }
        // third row;
        square = this.check(player, 6, 7, 8);
        if (square != -1){
          return square;
        }
        // first column;
        square = this.check(player, 0, 3, 6);
        if (square != -1){
          return square;
        }
        // second column
        square = this.check(player, 1, 4, 7);
        if (square != -1){
          return square;
        }
        // third column;
        square = this.check(player, 2, 5, 8);
        if (square != -1){
          return square;
        }
        // first diagonal;
        square = this.check(player, 0, 4, 8);
        if (square != -1){
          return square;
        }
        // second diagonal;
        square = this.check(player, 2, 4, 6);
        if (square != -1){
          return square;
        }
        
        return -1;

      }

      isBoardFull = () => {
        return !this.state.board.includes(0);
      }

      hasUserWon(){
        const board = this.state.board;
        const user  = this.user;
        return (
          (board[0] == user && board[1] == user && board[2] == user) || 
          (board[3] == user && board[4] == user && board[5] == user) || 
          (board[6] == user && board[7] == user && board[8] == user) || 
          (board[0] == user && board[3] == user && board[6] == user) || 
          (board[1] == user && board[4] == user && board[7] == user) || 
          (board[2] == user && board[5] == user && board[8] == user) || 
          (board[0] == user && board[4] == user && board[8] == user) || 
          (board[2] == user && board[4] == user && board[6] == user)
        )
      }

    }

    const Square = (props) => {
        return (
          <button style    = {{background: props.color}} 
                  disabled = {props.disableSquare} 
                  onClick  = {props.handleClick }
                  id       = {props.id}>
          </button>
        )
    }


    ReactDOM.render(<Board />, document.getElementById('app'));

  </script>
</body>
</html>
